{{ 'zsempiri-homepage.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign pcount   = section.settings.products_to_show
  assign bg       = section.settings.bg_color | default: '#FAF9F6'
  assign show_cnt = section.settings.show_count
  assign pt       = section.settings.padding_top
  assign pb       = section.settings.padding_bottom
-%}

<section
  class="zsempiri-coltabs"
  id="zcoltabs-{{ section.id }}"
  style="background-color: {{ bg }}; padding-top: {{ pt }}px; padding-bottom: {{ pb }}px;"
>
  <div class="zsempiri-coltabs__inner">

    {%- comment -%} ── Fejléc: cím + nyíl navigáció ────────────────── {%- endcomment -%}
    <div class="zsempiri-coltabs__header">
      {%- if section.settings.heading != blank -%}
        <h2 class="zsempiri-coltabs__heading">{{ section.settings.heading }}</h2>
      {%- endif -%}
      <div class="zsempiri-coltabs__nav">
        <button
          class="zsempiri-coltabs__nav-btn"
          id="zcoltabs-prev-{{ section.id }}"
          aria-label="Előző termékek"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
        </button>
        <button
          class="zsempiri-coltabs__nav-btn"
          id="zcoltabs-next-{{ section.id }}"
          aria-label="Következő termékek"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </button>
      </div>
    </div>

    {%- comment -%} ── Tab szűrők ──────────────────────────────────── {%- endcomment -%}
    {%- if section.blocks.size > 1 -%}
      <div class="zsempiri-coltabs__tabs" role="tablist">
        {%- for block in section.blocks -%}
          <button
            class="zsempiri-coltabs__tab{% if forloop.first %} is-active{% endif %}"
            role="tab"
            aria-selected="{{ forloop.first | json }}"
            aria-controls="zctp-{{ block.id }}"
            data-zcoltab="{{ block.id }}"
            {{ block.shopify_attributes }}
          >
            {{- block.settings.label -}}
            {%- if show_cnt and block.settings.collection != blank -%}
              <span class="zsempiri-coltabs__tab-count">{{ block.settings.collection.all_products_count }}</span>
            {%- endif -%}
          </button>
        {%- endfor -%}
      </div>
    {%- endif -%}

    {%- comment -%} ── Termék panelek ──────────────────────────────── {%- endcomment -%}
    {%- for block in section.blocks -%}
      <div
        class="zsempiri-coltabs__panel{% if forloop.first %} is-active{% endif %}"
        id="zctp-{{ block.id }}"
        role="tabpanel"
        data-zcolpanel="{{ block.id }}"
      >
        <div class="zsempiri-coltabs__grid" data-zcoltrack>
          {%- if block.settings.collection != blank -%}

            {%- for product in block.settings.collection.products limit: pcount -%}
              {%- assign ccard_alt = product.featured_image.alt | escape -%}
              <div class="zsempiri-ccard">
                <div class="zsempiri-ccard__media-wrap">
                  <a href="{{ product.url }}" class="zsempiri-ccard__img-link" aria-label="{{ product.title | escape }}">
                    <div class="zsempiri-ccard__media">
                      {%- if product.featured_image -%}
                        {{
                          product.featured_image
                          | image_url: width: 700
                          | image_tag:
                            class: 'zsempiri-ccard__img',
                            alt: ccard_alt,
                            loading: 'lazy',
                            widths: '350, 500, 700',
                            sizes: '(min-width: 750px) 346px, 50vw'
                        }}
                      {%- else -%}
                        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg zsempiri-ccard__img' }}
                      {%- endif -%}
                    </div>
                  </a>
                  <div class="zsempiri-ccard__actions">
                    <a href="{{ product.url }}"
                       class="zsempiri-ccard__action-btn"
                       data-action="quickview"
                       data-url="{{ product.url }}"
                       data-title="{{ product.title | escape }}"
                       data-img="{{ product.featured_image | image_url: width: 600 }}"
                       data-price="{{ product.price | money | escape }}"
                       {%- if product.compare_at_price > product.price -%}
                       data-compare-price="{{ product.compare_at_price | money | escape }}"
                       {%- endif -%}
                       data-desc="{{ product.description | escape }}"
                       data-vid="{{ product.selected_or_first_available_variant.id }}"
                       aria-label="{{ product.title | escape }} megtekintése">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                      </svg>
                    </a>
                    <a href="{{ product.url }}"
                       class="zsempiri-ccard__action-btn"
                       data-action="add-cart"
                       data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                       aria-label="{{ product.title | escape }} kosárba">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                      </svg>
                    </a>
                  </div>
                </div>
                <a href="{{ product.url }}" class="zsempiri-ccard__info" tabindex="-1" aria-hidden="true">
                  <p class="zsempiri-ccard__title">{{ product.title | truncate: 45 }}</p>
                  <p class="zsempiri-ccard__price">
                    {%- if product.compare_at_price > product.price -%}
                      <span class="zsempiri-ccard__price-sale">{{ product.price | money }}</span>
                      <s class="zsempiri-ccard__price-was">{{ product.compare_at_price | money }}</s>
                    {%- else -%}
                      <span>{{ product.price | money }}</span>
                    {%- endif -%}
                  </p>
                </a>
              </div>
            {%- else -%}
              {%- if request.design_mode -%}
                <p style="padding:2rem 0;opacity:.5;font-family:'Jost',sans-serif;color:var(--zsempiri-wood);">
                  Nincs termék ebben a gyűjteményben.
                </p>
              {%- endif -%}
            {%- endfor -%}

          {%- else -%}
            {%- comment -%} Placeholder — design mode / üres állapot {%- endcomment -%}
            {%- for i in (1..4) -%}
              <div class="zsempiri-ccard zsempiri-ccard--placeholder">
                <div class="zsempiri-ccard__media-wrap">
                  <div class="zsempiri-ccard__media">
                    {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg zsempiri-ccard__img' }}
                  </div>
                  <div class="zsempiri-ccard__actions">
                    <span class="zsempiri-ccard__action-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></span>
                    <span class="zsempiri-ccard__action-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></span>
                  </div>
                </div>
                <div class="zsempiri-ccard__info">
                  <p class="zsempiri-ccard__title">Termék neve</p>
                  <p class="zsempiri-ccard__price"><span>12 990 Ft</span></p>
                </div>
              </div>
            {%- endfor -%}
          {%- endif -%}
        </div>
      </div>
    {%- endfor -%}

    {%- comment -%} Design mode — üres section figyelmeztető {%- endcomment -%}
    {%- if request.design_mode and section.blocks.size == 0 -%}
      <div style="padding:3rem 2rem;text-align:center;border:2px dashed rgba(123,81,47,.25);border-radius:1rem;">
        <p style="font-family:'Grandstander',cursive;color:var(--zsempiri-wood);font-size:1.6rem;margin:0;">
          Adj hozzá gyűjtemény tab-okat a section beállításaiban!
        </p>
      </div>
    {%- endif -%}

  </div>
</section>

<script>
/* ============================================================
   Zsempiri — Shop Functions (globális, csak egyszer regisztrál)
   Add to Cart + Quick View Modal
   ============================================================ */
if (!window.zsempiriShopFns) {
  window.zsempiriShopFns = true;

  /* XSS-biztos szöveg HTML-be illesztéshez */
  function zEsc(str) {
    return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  /* ── Add to Cart ─────────────────────────────────────────── */
  window.zsempiriAddToCart = async function (variantId, btn) {
    if (btn.dataset.loading) return;
    btn.dataset.loading = '1';

    try {
      var res = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ id: parseInt(variantId, 10), quantity: 1 })
      });
      if (!res.ok) throw new Error('cart-add failed');

      /* Kosár darabszám frissítése */
      var cartRes = await fetch('/cart.js');
      var cart = await cartRes.json();
      document.querySelectorAll('.cart-count-bubble').forEach(function (el) {
        var n = el.querySelector('[aria-hidden]');
        var v = el.querySelector('.visually-hidden');
        if (n) n.textContent = cart.item_count;
        if (v) v.textContent = cart.item_count + ' items';
        el.classList.remove('is-empty');
      });

      /* Vizuális visszajelzés: zöld → visszaáll */
      btn.style.setProperty('background-color', 'var(--zsempiri-sage)');
      btn.style.setProperty('color', '#FDF6EA');
      setTimeout(function () {
        btn.style.removeProperty('background-color');
        btn.style.removeProperty('color');
        delete btn.dataset.loading;
      }, 1600);

    } catch (e) {
      delete btn.dataset.loading;
      console.error('[zsempiri] Add to cart error:', e);
    }
  };

  /* ── Quick View Modal ────────────────────────────────────── */
  var _qvModal = null;

  function _buildQVModal() {
    if (_qvModal) return _qvModal;
    _qvModal = document.createElement('div');
    _qvModal.id = 'zsempiri-qv-modal';
    _qvModal.setAttribute('role', 'dialog');
    _qvModal.setAttribute('aria-modal', 'true');
    _qvModal.innerHTML =
      '<div class="zsempiri-qv__backdrop"></div>' +
      '<div class="zsempiri-qv__dialog">' +
        '<button class="zsempiri-qv__close" aria-label="Bezárás">' +
          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" aria-hidden="true">' +
            '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>' +
          '</svg>' +
        '</button>' +
        '<div class="zsempiri-qv__body"></div>' +
      '</div>';
    document.body.appendChild(_qvModal);
    _qvModal.querySelector('.zsempiri-qv__backdrop').addEventListener('click', window.zsempiriCloseQV);
    _qvModal.querySelector('.zsempiri-qv__close').addEventListener('click', window.zsempiriCloseQV);
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && _qvModal && _qvModal.classList.contains('is-open')) {
        window.zsempiriCloseQV();
      }
    });
    return _qvModal;
  }

  window.zsempiriCloseQV = function () {
    if (_qvModal) _qvModal.classList.remove('is-open');
    document.body.style.overflow = '';
  };

  /* Szinkron quick view — minden adat a Liquid-rendered data attribútumokból jön */
  window.zsempiriOpenQV = function (btn) {
    var modal      = _buildQVModal();
    var body       = modal.querySelector('.zsempiri-qv__body');
    var title      = btn.dataset.title      || '';
    var imgSrc     = btn.dataset.img        || '';
    var price      = btn.dataset.price      || '';
    var cmpPrice   = btn.dataset.comparePrice || '';
    var desc       = btn.dataset.desc       || '';   /* Liquid: product.description | escape */
    var variantId  = btn.dataset.vid        || '';
    var productUrl = btn.dataset.url        || btn.getAttribute('href') || '#';

    var priceHtml = cmpPrice
      ? '<span class="zsempiri-qv__price-sale">' + zEsc(price) + '</span>' +
        '<s class="zsempiri-qv__price-was">' + zEsc(cmpPrice) + '</s>'
      : '<span>' + zEsc(price) + '</span>';

    body.innerHTML =
      '<div class="zsempiri-qv__layout">' +
        '<div class="zsempiri-qv__media">' +
          (imgSrc ? '<img src="' + zEsc(imgSrc) + '" alt="' + zEsc(title) + '" class="zsempiri-qv__img" loading="lazy">' : '') +
        '</div>' +
        '<div class="zsempiri-qv__info">' +
          '<h2 class="zsempiri-qv__title">' + zEsc(title) + '</h2>' +
          '<p class="zsempiri-qv__price">' + priceHtml + '</p>' +
          (desc ? '<div class="zsempiri-qv__desc">' + desc + '</div>' : '') +
          '<div class="zsempiri-qv__btns">' +
            (variantId ? '<button class="zsempiri-qv__add-btn" data-vid="' + zEsc(variantId) + '">Kosárba</button>' : '') +
            '<a href="' + zEsc(productUrl) + '" class="zsempiri-qv__view-link">Termék megtekintése →</a>' +
          '</div>' +
        '</div>' +
      '</div>';

    if (variantId) {
      body.querySelector('.zsempiri-qv__add-btn').addEventListener('click', function () {
        zsempiriAddToCart(this.dataset.vid, this);
      });
    }

    modal.classList.add('is-open');
    document.body.style.overflow = 'hidden';
  };
}

/* ============================================================
   Section-specifikus: tabs, carousel, gomb-kötések
   ============================================================ */
(function () {
  var root = document.getElementById('zcoltabs-{{ section.id }}');
  if (!root) return;

  var tabs   = root.querySelectorAll('[data-zcoltab]');
  var panels = root.querySelectorAll('[data-zcolpanel]');

  /* ── Tab váltás ─────────────────────────────────────────── */
  tabs.forEach(function (tab) {
    tab.addEventListener('click', function () {
      var id = tab.getAttribute('data-zcoltab');
      tabs.forEach(function (t) {
        t.classList.remove('is-active');
        t.setAttribute('aria-selected', 'false');
      });
      panels.forEach(function (p) { p.classList.remove('is-active'); });
      tab.classList.add('is-active');
      tab.setAttribute('aria-selected', 'true');
      var panel = root.querySelector('[data-zcolpanel="' + id + '"]');
      if (panel) {
        panel.classList.add('is-active');
        var track = panel.querySelector('[data-zcoltrack]');
        if (track) track.scrollLeft = 0;
      }
    });
  });

  /* ── Carousel navigáció ─────────────────────────────────── */
  function activeTrack() {
    var ap = root.querySelector('.zsempiri-coltabs__panel.is-active');
    return ap ? ap.querySelector('[data-zcoltrack]') : null;
  }

  var prevBtn = document.getElementById('zcoltabs-prev-{{ section.id }}');
  var nextBtn = document.getElementById('zcoltabs-next-{{ section.id }}');

  if (prevBtn) {
    prevBtn.addEventListener('click', function () {
      var t = activeTrack();
      if (t) t.scrollBy({ left: -t.clientWidth, behavior: 'smooth' });
    });
  }
  if (nextBtn) {
    nextBtn.addEventListener('click', function () {
      var t = activeTrack();
      if (t) t.scrollBy({ left: t.clientWidth, behavior: 'smooth' });
    });
  }

  /* ── Quick View gombok ───────────────────────────────────── */
  root.querySelectorAll('[data-action="quickview"]').forEach(function (btn) {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      zsempiriOpenQV(btn);  /* a gomb maga tartalmazza az összes adatot */
    });
  });

  /* ── Add to Cart gombok ──────────────────────────────────── */
  root.querySelectorAll('[data-action="add-cart"]').forEach(function (btn) {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      zsempiriAddToCart(btn.dataset.variantId, btn);
    });
  });
})();
</script>

{% schema %}
{
  "name": "Zsempiri — Termékek",
  "tag": "section",
  "class": "section",
  "max_blocks": 6,
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Cím",
      "default": "Legújabb termékeink"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Termék / gyűjtemény",
      "min": 4,
      "max": 16,
      "step": 4,
      "default": 8
    },
    {
      "type": "checkbox",
      "id": "show_count",
      "label": "Termékszám mutatása",
      "default": true
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Háttérszín",
      "default": "#FAF9F6"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Felső margó (px)",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Alsó margó (px)",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 48
    }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Gyűjtemény tab",
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Gyűjtemény"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Tab felirat",
          "default": "Kollekció"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Zsempiri — Termékek",
      "blocks": [
        { "type": "tab", "settings": { "label": "Összes" } }
      ]
    }
  ]
}
{% endschema %}
